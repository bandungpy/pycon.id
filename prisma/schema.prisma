// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex", "metrics", "views"]
}

model User {
  id String @id @default(cuid())

  email    String @unique
  name     String
  username String @unique

  role   UserRole? @relation(fields: [roleId], references: [id])
  roleId String?

  participantType String @default("non-participant")

  ticketTransactions  TicketTransaction[]
  vouchers            Voucher[]
  voucherTransactions VoucherTransaction[]

  speaker Speaker? // User can link as the Speaker

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([roleId])
}

model UserRole {
  id String @id @default(cuid())

  sequence    Int    @unique // 1 | 2 | 3 | ...
  symbol      String @unique // "ADMIN" | "MANAGER" | "EDITOR"
  name        String @unique // "Administrator" | "Manager" | "Editor"
  description String @db.Text // "Manage everything"

  users User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Speaker {
  id String @id @default(cuid())

  slug String  @unique
  name String  @unique
  bio  String?

  // Speaker can link with their User account
  user   User?   @relation(fields: [userId], references: [id])
  userId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Ticket {
  id String @id @default(cuid())

  name  String
  quota Int
  price Int

  earlyBird Boolean @default(false)
  description String?

  transactions TicketTransaction[]
  features TicketFeature[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TicketFeature {
  id String @id @default(cuid())

  feature String?

  ticket   Ticket? @relation(fields: [ticketId], references: [id])
  ticketId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ticketId])
}

model TicketTransaction {
  id String @id @default(cuid())

  status      String @default("pending")
  description String?

  ticket   Ticket? @relation(fields: [ticketId], references: [id])
  ticketId String?
  paymentId String
  transactionId String

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([ticketId])
}

model Voucher {
  id String @id @default(cuid())

  name  String
  code  String
  quota Int    @default(0)
  private Boolean @default(false)

  discount    Int
  description String

  transactions VoucherTransaction[]
  whitelists VoucherWhitelist[]

  requirement   VoucherRequirement? @relation(fields: [requirementId], references: [id])
  requirementId String?

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([requirementId])
  @@index([userId])
}

model VoucherRequirement {
  id String @id @default(cuid())

  description String

  vouchers Voucher[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VoucherTransaction {
  id String @id @default(cuid())

  status      Boolean
  description String

  voucher   Voucher? @relation(fields: [voucherId], references: [id])
  voucherId String?

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([voucherId])
  @@index([userId])
}

model VoucherWhitelist {
  id String @id @default(cuid())

  email String

  voucher   Voucher? @relation(fields: [voucherId], references: [id])
  voucherId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([voucherId])
}
